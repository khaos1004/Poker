
const Result = require('./result');
const axios = require('axios'); // axios Ï∂îÍ∞Ä

module.exports = class Game {

    init() {
        this.cards = require('./card')();
        this.userCard = new Map();
        this.turn = 3;
        this.betList = {};
        this.callList = {};
        this.betCntList = {};
        this.maxCall = 0;
        this.pot = 0;
        this.defaultPrice = 100;
        this.defaultCount = 1;
        if (!this.userMoney) {
            this.userMoney = {}; // Í∏∞Ï°¥ Í∞íÏù¥ ÏóÜÏùÑ ÎïåÎßå Ï¥àÍ∏∞Ìôî
        }
    }

    choice(io, roomId, socketId, cards, userList) {
        console.log(`received choice by ${socketId}`);

        this.userCard.set(socketId, cards);

        console.log(this.userCard);

        if (this.userCard.size == userList.length) {
            //all choice complete 
            console.log("all choice complete!!");
            this.sevenTurn(io, roomId, userList);
        }
    }


    start(io, userList) {

        this.cards.init();
        this.cards.suffle();
        this.maxCall = 0;

        for (var u of userList) {

            let playerSocket = io.sockets.sockets.get(u);
            let startingMoney = playerSocket?.playerData?.money || 10000; // URLÏóêÏÑú Î∞õÏùÄ Í∏àÏï°

            // Í∏∞Ï°¥ Î≥¥Ïú† Í∏àÏï° Ïú†ÏßÄÌïòÎèÑÎ°ù Î≥ÄÍ≤Ω
            if (this.userMoney[u] === undefined) {
                this.userMoney[u] = startingMoney; // Ï≤òÏùå Ï∞∏Í∞ÄÌïú Í≤ΩÏö∞ÏóêÎßå ÏÑ§Ï†ï
            }

            this.pot += this.defaultPrice;
            this.betList[u] = this.defaultPrice;
            this.callList[u] = 0;
            this.betCntList[u] = this.defaultCount;
            this.userMoney[u] -= this.defaultPrice; // Î≤†ÌåÖ Í∏àÏï° Ï∞®Í∞ê

            let choiceCard = this.cards.choice();
            io.to(u).emit("choice", {
                cards: choiceCard,
                myMoney: this.userMoney[u] // ÌîåÎ†àÏù¥Ïñ¥Ïùò Î≥¥Ïú† Í∏àÏï° Ï†ÑÏÜ°
            });
        }
    }

    sevenTurn(io, roomId, userList) {
        if (this.turn == 7) {
            let userCard3 = {};
            for (var u of userList) {
                userCard3[u] = [];
                for (var c of this.userCard.get(u)) {
                    userCard3[u].push(c);
                }
            }
            this.gameOver(io, roomId, userList, userCard3);
            return;
        }
        this.turn += 1;
        console.log("sevenTurn(), turn = " + this.turn);

        //GIVE
        let userCard2 = {};
        for (var u of userList) {
            this.userCard.get(u).push(this.cards.openPop());
            userCard2[u] = [];
            for (var c of this.userCard.get(u)) {
                if (c.isShow) {
                    userCard2[u].push(c);
                }
            }

            let myResult = new Result(this.userCard.get(u));
            let myCalcResult = myResult.calc();
            let myLevel = myCalcResult.madeLevel;
            io.to(u).emit('give_my_card_info', {
                cards: this.userCard.get(u),
                level: myLevel
            });
        }
        io.sockets.in(roomId).emit('give_user_card_info', {
            cards: userCard2
        });
        console.log('GIVE END');



        //BOSS
        let bossId = this.whosTheBoss(userList, userCard2);
        console.log("boss is " + bossId);
        io.sockets.in(roomId).emit('boss', {
            bossId: bossId
        });
        console.log('BOSS END');


        //BETTING
        this.updateBettingInfo(io, roomId, bossId, userList, null, null);
    }


    whosTheBoss(userList, userCard) {
        for (var u of userList) {
            if (this.callList[u] < 0) {
                continue;
            }
            let cards = userCard[u];
            let r1 = new Result(cards);
            let win = 0;

            r1.calc();
            for (var u2 of userList) {
                if (this.callList[u2] < 0) {
                    win += 1;
                    continue;
                }
                if (u == u2) {
                    continue;
                }
                let cards2 = userCard[u2];
                let r2 = new Result(cards2);
                r2.calc();

                if (r1.compare(r2)) {
                    win += 1;
                }
            }

            if (win == userList.length - 1) {
                return u;
            }
        }
        return 0;
    }

    updateBettingInfo(io, roomId, currentUserId, userList, userId, type) {
        if (userId == null && type == null) {
            io.sockets.in(roomId).emit('bettingInfo', {
                currentUserId: currentUserId,
                userList: userList,
                pot: this.pot,
                maxCall: this.maxCall,
                callList: this.callList,
                turn: this.turn,
                hasBetCnt: this.betCntList[currentUserId] != 0
            });
            return;
        }

        let myCall = this.maxCall - this.callList[userId];
        let betPrice = this.calcBet(userId, userList, type, myCall);

        console.log(`üí∞ ${userId} Î≤†ÌåÖ Í∏àÏï°: ${betPrice}, Î≤†ÌåÖ ÌõÑ ÎÇ®ÏùÄ Í∏àÏï°: ${this.userMoney[userId]}`);

        let nextUserId = this.findNextUserId(userList, currentUserId);
        console.log('next user id = ' + nextUserId);

        io.sockets.in(roomId).emit('bettingInfo', {
            userId: userId,
            userList: userList,
            pot: this.pot,
            maxCall: this.maxCall,
            callList: this.callList,
            betPrice: betPrice,
            turn: this.turn,
            type: type
        });

        if (nextUserId == null) {
            this.maxCall = 0;
            let dieCnt = 0;
            for (var u of userList) {
                if (this.callList[u] >= 0) {
                    this.callList[u] = 0;
                    this.betCntList[u] = this.defaultCount;
                } else {
                    dieCnt += 1;
                }
            }
            if (dieCnt >= userList.length - 1) {
                this.turn = 7;
            }
            this.sevenTurn(io, roomId, userList);
        } else {
            this.updateBettingInfo(io, roomId, nextUserId, userList, null, null);
        }
    }


    findNextUserId(userList, currentUserId) {
        if (this.maxCall == 0) {
            return null;
        }
        let idx = 0;
        for (var i = 0; i < userList.length; i++) {
            if (userList[i] == currentUserId) {
                idx = i;
                break;
            }
        }

        for (let cnt = 0; cnt < userList.length; cnt++) {
            idx += 1;
            if (idx == userList.length) {
                idx = 0;
            }
            let u = userList[idx];
            if (this.callList[u] < 0) { //die case
                continue;
            }

            if (this.betCntList[u] > 0) {
                return u;
            } else if (this.betCntList[u] == 0 && this.callList[u] != this.maxCall) {
                return u;
            }
        }
        return null;
    }


    calcBet(userId, userList, type, myCall) {
        let prevUserId = '';
        for (var i = 0; i < userList.length; i++) {
            if (userList[i] == userId) {
                let idx = i == 0 ? userList.length - 1 : i - 1;
                prevUserId = userList[idx];
                break;
            }
        }

        if (type == 'call') {
            this.callList[userId] += myCall;
        } else if (type == 'die') {
            this.callList[userId] = -1;
        } else if (type == 'half') {
            this.callList[userId] += myCall + Math.round((this.pot + myCall) * 0.5);
        } else if (type == 'quater') {
            this.callList[userId] += myCall + Math.round((this.pot + myCall) * 0.25);
        } else if (type == 'double') {
            this.callList[userId] += this.callList[prevUserId] * 2;
        } else if (type == 'bing') {
            this.callList[userId] += this.defaultPrice;
        }

        let betAmount = this.callList[userId];
        this.userMoney[userId] -= betAmount; // Î≥¥Ïú† Í∏àÏï°ÏóêÏÑú Ï∞®Í∞ê
        this.pot += betAmount;
        this.betList[userId] += betAmount;

        if (this.maxCall < this.callList[userId]) {
            this.maxCall = this.callList[userId];
        }

        this.betCntList[userId] -= 1;

        return betAmount; // bet price Î∞òÌôò
    }


    betting(io, roomId, userList, userId, type) {
        io.sockets.in(roomId).emit('betting', {
            userId: userId,
            type: type
        });

        this.updateBettingInfo(io, roomId, userId, userList, userId, type);
    }
    

    gameOver(io, roomId, userList, userCard) {
        console.log("game over!!!");

        let winner = null;
        let resultData = [];

        for (let u of userList) {
            if (this.callList[u] < 0) {
                continue;
            }
            let cards = userCard[u];
            let r1 = new Result(cards);
            let win = 0;

            r1.calc();
            for (let u2 of userList) {
                if (this.callList[u2] < 0) {
                    win += 1;
                    continue;
                }
                if (u === u2) {
                    continue;
                }
                let cards2 = userCard[u2];
                let r2 = new Result(cards2);
                r2.calc();

                if (r1.compare(r2)) {
                    win += 1;
                }
            }

            if (win === userList.length - 1) {
                winner = u;
            }
        }

        // üõ†Ô∏è ÏäπÏûê Î≥¥Ïú† Í∏àÏï° ÏóÖÎç∞Ïù¥Ìä∏ (Ïù¥ ÏΩîÎìúÍ∞Ä API ÏöîÏ≤≠ Ï†ÑÏóê Î®ºÏ†Ä Ïã§ÌñâÎêòÏñ¥Ïïº Ìï®)
        if (winner) {
            console.log(`winner is ${winner}`);
            console.log(`Ïù¥Ï†Ñ Î≥¥Ïú† Í∏àÏï°: ${this.userMoney[winner]}`);
            console.log(`Ìåü Î®∏Îãà: ${this.pot}`);

            this.userMoney[winner] += this.pot;

            console.log(`ÏäπÎ¶¨ ÌõÑ Î≥¥Ïú† Í∏àÏï°: ${this.userMoney[winner]}`); // ‚úÖ Ïó¨Í∏∞ ÌôïÏù∏
        }

        // üõ†Ô∏è ÏµúÏã† Î≥¥Ïú† Í∏àÏï°ÏùÑ Î∞òÏòÅÌïòÏó¨ resultData ÏÉùÏÑ±
        for (let u of userList) {
            console.log(`ÌîåÎ†àÏù¥Ïñ¥ ${u} ÏµúÏ¢Ö Î≥¥Ïú† Í∏àÏï°: ${this.userMoney[u]}`);

            resultData.push({
                userkey: io.sockets.sockets.get(u)?.playerData?.userkey || "unknown",
                nyangAmount: this.userMoney[u] || 0
            });
        }

        // üõ†Ô∏è API ÏöîÏ≤≠ ÏßÅÏ†Ñ ÏµúÏ¢Ö Î°úÍ∑∏ Ï∂îÍ∞Ä
        console.log('API ÏöîÏ≤≠ Îç∞Ïù¥ÌÑ∞ (Ï†ÑÏÜ° ÏßÅÏ†Ñ):', JSON.stringify(resultData, null, 2));

        // Í≤åÏûÑ Í≤∞Í≥º API Ìò∏Ï∂ú
        axios.post('https://svr.sotong.com/api/v1/games/result', { gamers: resultData }, {
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                console.log('Í≤åÏûÑ Í≤∞Í≥º API ÏùëÎãµ:', response.data);
            })
            .catch(error => {
                console.error('Í≤åÏûÑ Í≤∞Í≥º API Ìò∏Ï∂ú Ï§ë ÏóêÎü¨ Î∞úÏÉù:', error);
            });

        // Î™®Îì† Ïú†Ï†ÄÏùò ÏµúÏã† Î≥¥Ïú† Í∏àÏï°ÏùÑ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Î°ú Ï†ÑÎã¨
        io.sockets.in(roomId).emit('gameover', {
            userList: userList,
            userCard: userCard,
            winner: winner,
            userMoney: this.userMoney
        });

        this.pot = 0;
    }

}